# วิเคราะห์กรณี ZEC ซื้อแล้วขายขาดทุนทันที

## สิ่งที่เกิดขึ้นใน log
- สัญญาณขายมาจากเงื่อนไข `IDLE_EXIT` หลังถือมานานกว่าค่า `time_caps.T_idle_max_minutes` และราคายกขึ้นมาถึงจุดคุ้มทุน + ส่วนกันชน (`p_idle` หรือ `no_loss_epsilon`).
- จุดเป้าหมายขายที่เครื่องยนต์คำนวณได้อยู่ราว 431.12 USDT แต่คำสั่ง **MARKET SELL** ถูกเติมที่ ~428.91–428.90 USDT ก่อนที่คำสั่งจะถูกส่ง ทำให้ได้ราคาต่ำกว่าเป้าหมายทันทีและเกิดขาดทุนสุทธิแม้สัญญาณตั้งใจจะออกใกล้คุ้มทุน.

## สาเหตุหลัก
1. **สลิปเพจระหว่างสัญญาณกับราคาตลาดจริง**: เงื่อนไข `IDLE_EXIT` ตรวจจาก high/close ของแท่ง แต่คำสั่งขายถูกยิงแบบ market ภายหลังไม่กี่รอบ polling ราคาลดลงจึงได้ fill ต่ำกว่าเป้า
2. **ไม่มีการกันสลิปเพจสำหรับ exit**: ก่อนหน้าไม่มีเกณฑ์บังคับให้ราคาตลาดต้องไม่หลุดเป้าหมายเกินค่าหนึ่ง ทำให้คำสั่งหลุดลงมาหลายดอลลาร์ได้แม้เป็นสัญญาณออกแบบ “พอจบได้”

## ทางแก้ที่ทำไว้ในโค้ด
- เพิ่มตัวเลือก `general.max_exit_slippage_pct` (ดีฟอลต์ 0.003 = 0.3%). หากราคาปัจจุบันต่ำกว่าราคาเป้าหมายของสัญญาณขายเกินค่านี้ ระบบจะไม่ส่งคำสั่ง EXIT ในรอบนั้นและบันทึกเหตุการณ์ `EXIT_ABORTED_SLIPPAGE` เพื่อให้ลองใหม่เมื่อราคารีบาวด์กลับขึ้นมา.

## ข้อเสนอเสริมสำหรับการตั้งค่า
- ถ้าตลาดบางคู่สวิงแรงกว่าปกติ ให้เพิ่ม `p_idle` หรือยืด `T_idle_max_minutes` เพื่อลดการออกใกล้คุ้มทุนเกินไป
- หากต้องการลดการปฏิเสธ exit บ่อยๆ ให้ตั้ง `max_exit_slippage_pct` สูงขึ้นเล็กน้อย (เช่น 0.005) แต่ถ้าต้องการกันการขายต่ำเกิน ให้ลดค่านี้ลง
- พิจารณาใช้ `sell_scale_out` (แบ่งขาย) ต่อเมื่อออกกำไรเท่านั้น (`profit_only: true`) เพื่อไม่ให้โดนสลิปเพจสองครั้งในกรณีออกขาดทุน