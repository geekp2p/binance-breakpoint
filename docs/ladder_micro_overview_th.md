# ภาพรวมการทำงาน Ladder vs Micro (ภาษาไทย)

เอกสารนี้สรุปว่า "ladder" และ "micro" ในโค้ดทำงานอย่างไร ใช้ทุน/คำนวณกำไรแบบไหน และควรคุยกับบอท/ปรับ config ด้วยคำสั่ง prompt อย่างไรเมื่ออยากให้รวมยอดขายหรือเร่งปิดกำไร

## Ladder: สะสมรวม คำนวณกำไรเป็นกองเดียว
- การซื้อแต่ละไม้ถูกนับเป็นขั้นบันได (`ladder_next_idx`) แต่ต้นทุนและกำไรจริงถูกคิด **รวมเป็นกองเดียว** จากปริมาณสุทธิ (`net_qty`) และต้นทุนสุทธิ (`net_cost`) ไม่ได้ขายทีละไม้แยกกำไรของตัวเอง【F:live_trader.py†L1121-L1133】
- PnL breakdown แยกให้ดูได้ว่า ladder ทำกำไร/ขาดทุนเท่าไร แต่ยังเป็นการคิดบนกองรวม ไม่ใช่ per-leg【F:live_trader.py†L1081-L1103】
- เมื่อถึงเงื่อนไขขาย (trail, sell_at_height, time caps) ระบบจะปล่อยออเดอร์ตามกลยุทธ์ขายที่ตั้งไว้ เช่น scale-out 2 ชิ้น หรือปิดทั้งกอง ถ้าราคาไม่ดีดขึ้นก็ยังมี `p_idle`/`T_total_cap_minutes` บังคับปิดที่กำไรขั้นต่ำตาม config【F:docs/config-behavior.md†L41-L58】【F:docs/config-behavior.md†L94-L116】
- ดังนั้นภาพที่เห็นในแอปอาจเป็นคำสั่งขายย่อยหลายบรรทัด (เพราะ scale-out / rip play) แต่ทั้งหมดคิดจากกองต้นทุนเดียว ไม่ได้ถือว่าเป็นกำไรทีละไม้แยกกัน

## Micro: เล่นรอบสั้น แยกบัญชีผลลัพธ์
- Micro entries (`micro_oscillation`) เปิด/ปิดรอบสั้นด้วยทุนสัดส่วนเล็ก และถูกบันทึกกำไรแยกจาก ladder ผ่านฟังก์ชัน split และ breakdown【F:live_trader.py†L1064-L1103】
- เมื่อ Micro เข้าในราคาที่ต่ำกว่า ladder mark ระบบจะ "nudge" ความคืบหน้าบันไดให้ขยับไปข้างหน้า ทำให้จุดกำไรของรอบหลักขยับขึ้นใกล้ราคาเด้งเร็วขึ้น แต่ทุนและ PnL ของ micro ยังถูกแยกบันทึก【F:tests/test_ladder.py†L134-L169】
- Micro guard สามารถเบรกไม่ให้ micro ยิงเพิ่มเมื่อผลรวม micro ติดลบเกิน buffer ที่อิงจากกำไร/ขาดทุนของ ladder【F:live_trader.py†L1105-L1118】

## สรุปคำตอบคำถามที่เจอบ่อย
- **“ladder ขายทีละไม้หรือรวมยอด?”** → รวมยอดเสมอ: ต้นทุน/กำไรถือเป็นกองเดียว แล้วขายตามเงื่อนไขที่ตั้ง (อาจแบ่งก้อนได้เพื่อหลีกเลี่ยง slippage)
- **“ถ้าราคาไม่เด้งจะรีบขายทั้งกองไหม?”** → มี time caps (`p_idle`, `T_total_cap_minutes`) และ trail lock ที่จะปิดตำแหน่งเมื่อถึงกำไรขั้นต่ำหรือครบเวลา แม้ราคาไม่กลับถึงจุดสูงเดิม
- **“Micro ไปปนกับ ladder ไหม?”** → แยกบัญชี แต่สามารถขยับ progress ladder และถูก guard ด้วยผลรวม ladder/micro

## Prompt ตัวอย่างเพื่อขอปรับพฤติกรรม
คัดลอก/ปรับแก้แล้วส่งให้บอทที่ช่วยปรับ config หรืออธิบายการทำงาน:

```
สรุปจุดเข้าซื้อ/ขายของ ladder รอบปัจจุบัน แล้วปรับ config ให้:
- ปิดทั้งกองทันทีที่ unrealized >= 0.8% หรือถึงกำไรขั้นต่ำ p_idle
- ลดจำนวนชิ้น scale-out เหลือ 1 ชิ้นเพื่อให้ขายรวดเดียว
- เปิด micro_nudge ให้อัปเดต ladder_next_idx เมื่อ micro เข้าต่ำกว่า mark
- รายงานว่าผลรวม PnL ladder กับ micro แยกกันอย่างไร และ buffer micro_guard คิดจากอะไร
ใช้ค่าใน config.yaml เป็นฐาน แล้วคืนค่า diff ที่ต้องเปลี่ยน
```

> หมายเหตุ: หากต้องการโหมด "ยิงครบแล้วขายรวดเดียว" ให้ตั้ง `sell_scale_out.chunks = 1` และเพิ่ม `p_idle` ให้สูงพอจะปิดกำไรเมื่อครบเวลา โดยยังคงใช้ trail เพื่อปกป้องกำไรหากราคาดีดต่อ

### เลือกขายรวดเดียวหรือแบ่งก้อน: แนะนำให้ดู 3 จุดนี้
- **อยากปิดไว รีบกินกำไรทั้งกอง** → ตั้ง `sell_scale_out.chunks = 1` แล้วเพิ่ม `p_idle` ให้สูงพอจะปิดที่กำไรขั้นต่ำแม้ราคาจะไม่เด้งมาก ช่วยลดความเสี่ยงราคาดีดไม่ถึงจุดขายทีละขั้น
- **อยากเผื่อราคาดีดต่อ ลด slippage** → ใช้ `sell_scale_out.chunks > 1` (เช่น 2 ชิ้น) เพื่อทยอยขายบางส่วนก่อน แล้วปล่อย trail lock ล็อกกำไรส่วนที่เหลือ หากราคากลับลงมาก่อน trail ทำงานก็ยังมีกำไรจากก้อนแรกมาช่วยพยุง
- **ไม่แน่ใจให้ลองผสม** → เริ่มที่ 2 ชิ้น (50/50) พร้อม `p_idle` พอประมาณเพื่อปิดดีลหากลากนานเกินไป แล้วดูผลลัพธ์ปรับเพิ่ม/ลดจำนวนชิ้นได้ตามสไตล์ความเสี่ยงที่รับไหว

### พรีเซ็ตแนะนำ: ขายแบบ 70% → 20% → 10% เมื่อราคาดีดขึ้น
- ระบบ `sell_scale_out` แบ่งขนาดออเดอร์เป็น **เท่าๆ กัน** ตามจำนวน `chunks` ที่ตั้งไว้ (เช่น 3 ก้อนคือ ~33/33/34%) ไม่ได้ตั้งสัดส่วนเองได้ ถ้าอยากได้สัดส่วน 70/20/10 จริงๆ ต้องสั่งขายมือหรือใช้สคริปต์ภายนอกประกบ【F:live_trader.py†L2132-L2144】
- แนวทางใกล้เคียงในตัวระบบ: ตั้ง `sell_scale_out.chunks = 3`, `delay_seconds` สั้นๆ (เช่น 1–3 วินาที) เพื่อให้ก้อนที่ 2 และ 3 ไล่ตามราคาดีด ถ้าราคาแค่ดีดสั้นๆ จะได้ขายประมาณ 1/3–2/3 ของของในราคาดีกว่าเดิม
- เพื่อบังคับให้ทุกก้อนปิดที่กำไรเสมอ ให้เปิด `sell_scale_out.profit_only = true` และเพิ่ม `p_idle` เป็นค่าบวก (เช่น 0.3–0.5%) คู่กับ `T_total_cap_minutes` ที่รับได้ จะได้มี “เพดานเวลา” ปิดทำกำไรขั้นต่ำแม้ราคาจะนิ่งนาน

#### Prompt ตัวอย่างสำหรับพรีเซ็ต 70/20/10 แบบใกล้เคียง
คัดลอก/ปรับแก้แล้วส่งให้บอทเพื่อปรับ config:

```
สรุปสถานะ ladder ปัจจุบัน แล้วปรับ config ให้:
- general.sell_scale_out = { chunks: 3, delay_seconds: 2, profit_only: true }
- ตั้ง p_idle = 0.4% และ T_total_cap_minutes = 45 เพื่อปิดทำกำไรขั้นต่ำถ้าราคานิ่งนาน
- ย้ำเตือนว่าระบบแบ่งก้อนเท่าๆ กัน (~33/33/34) ไม่ได้ 70/20/10 ตรงๆ ถ้าต้องการสัดส่วนเป๊ะให้เตรียมคำสั่งขายมือ 70% ก่อน แล้วปล่อย scale-out 2 ก้อนที่เหลือ
- รายงานผลรวม PnL ladder/micro แยกกัน และเตือน micro_guard ตาม buffer เดิม
ส่ง diff ของ config.yaml ที่ต้องเปลี่ยนกลับมา
```