<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Binance Breakpoint - Profit & Control</title>
  <style>
    :root {
      color-scheme: dark light;
      --accent: #2d8cf0;
      --danger: #f44336;
      --success: #4caf50;
      --bg: #0f172a;
      --surface: #1e293b;
      --text: #e2e8f0;
      --muted: #94a3b8;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
    }

    body {
      margin: 0;
      background: linear-gradient(135deg, rgba(45, 140, 240, 0.15), rgba(15, 23, 42, 0.9));
      color: var(--text);
      min-height: 100vh;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 20px 48px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    h1 {
      margin: 0;
      font-size: 1.5rem;
      letter-spacing: 0.01em;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .input {
      background: var(--surface);
      border: 1px solid #334155;
      color: var(--text);
      padding: 8px 10px;
      border-radius: 8px;
      min-width: 260px;
    }

    button {
      border: none;
      border-radius: 8px;
      padding: 9px 14px;
      cursor: pointer;
      font-weight: 600;
      color: #fff;
      background: var(--accent);
      box-shadow: 0 8px 30px rgba(45, 140, 240, 0.25);
      transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 40px rgba(45, 140, 240, 0.35);
      filter: brightness(1.05);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 6px 20px rgba(45, 140, 240, 0.25);
    }

    .btn-secondary {
      background: #475569;
      box-shadow: none;
    }

    .btn-danger {
      background: var(--danger);
      box-shadow: none;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 14px;
      margin-bottom: 18px;
    }

    .card {
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 14px 16px;
      backdrop-filter: blur(8px);
      box-shadow: 0 16px 50px rgba(0, 0, 0, 0.35);
    }

    .card h3 {
      margin: 0 0 6px;
      font-size: 0.95rem;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .value {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: #0f172a;
      color: var(--muted);
      border: 1px solid #1e293b;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(15, 23, 42, 0.7);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.25);
    }

    thead {
      background: rgba(30, 41, 59, 0.8);
      color: var(--muted);
      text-transform: uppercase;
      font-size: 0.78rem;
      letter-spacing: 0.04em;
    }

    th, td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      vertical-align: middle;
    }

    tbody tr:hover {
      background: rgba(45, 140, 240, 0.04);
    }

    .status {
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      display: inline-block;
    }

    .status.live { background: rgba(76, 175, 80, 0.15); color: var(--success); }
    .status.paused { background: rgba(244, 67, 54, 0.15); color: var(--danger); }

    .pnl-pos { color: var(--success); }
    .pnl-neg { color: var(--danger); }
    .muted { color: var(--muted); font-size: 0.92rem; }

    .ladder-steps { margin-top: 4px; }
    .ladder-steps summary {
      list-style: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #334155;
      background: rgba(45, 140, 240, 0.08);
      color: var(--text);
      font-weight: 600;
      user-select: none;
    }
    .ladder-steps summary::-webkit-details-marker { display: none; }
    .ladder-steps[open] summary { border-color: var(--accent); background: rgba(45, 140, 240, 0.14); }
    .ladder-badges { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .ladder-badge {
      display: inline-block;
      padding: 4px 6px;
      border-radius: 8px;
      background: rgba(45, 140, 240, 0.12);
      border: 1px solid rgba(45, 140, 240, 0.25);
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text);
    }
    .ladder-badge.filled {
      background: rgba(76, 175, 80, 0.15);
      border-color: rgba(76, 175, 80, 0.35);
      color: var(--success);
    }

    .timestamp {
      display: inline-block;
      margin-top: 2px;
      font-size: 0.78rem;
      word-break: break-all;
    }

    .log-wrapper {
      margin-top: 16px;
    }

    .log-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .log-feed {
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 12px;
      font-family: "JetBrains Mono", "SFMono-Regular", Consolas, "Liberation Mono", monospace;
      font-size: 0.9rem;
      max-height: 340px;
      overflow-y: auto;
      white-space: pre-wrap;
      line-height: 1.3;
    }

    .log-line { color: var(--text); display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .log-line .sym { color: var(--accent); font-weight: 700; }
    .log-line .kind { color: var(--muted); font-weight: 700; min-width: 100px; }
    .log-line .log-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.78rem;
      letter-spacing: 0.02em;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .log-badge.trade { background: rgba(76, 175, 80, 0.1); border-color: rgba(76, 175, 80, 0.35); color: var(--success); }
    .log-badge.ladder { background: rgba(45, 140, 240, 0.12); border-color: rgba(45, 140, 240, 0.35); color: var(--accent); }
    .log-badge.micro { background: rgba(244, 164, 96, 0.12); border-color: rgba(244, 164, 96, 0.35); color: #fbbf24; }
    .log-badge.status { background: rgba(148, 163, 184, 0.12); border-color: rgba(148, 163, 184, 0.35); color: var(--muted); }
    .log-badge.alert { background: rgba(244, 67, 54, 0.12); border-color: rgba(244, 67, 54, 0.35); color: var(--danger); }
    .log-badge.info { background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.2); color: var(--text); }
    .log-line .meta { color: var(--muted); font-size: 0.85rem; }
    .log-line .timestamp { color: var(--muted); font-weight: 700; min-width: 74px; }
    .log-line .count { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 8px; font-weight: 700; }
    .log-line .pnl-pos { color: var(--success); font-weight: 700; }
    .log-line .pnl-neg { color: var(--danger); font-weight: 700; }

    .phase {
      font-size: 0.88rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .footer {
      margin-top: 16px;
      color: var(--muted);
      font-size: 0.88rem;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .error {
      margin-top: 12px;
      color: var(--danger);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Binance Breakpoint – PnL & Control</h1>
      <div class="controls">
        <input
          id="apiBase"
          class="input"
          type="text"
          value="http://45.154.25.16::8082"
          aria-label="API base URL"
        />
        <input
          id="pairSymbol"
          class="input"
          type="text"
          value=""
          placeholder="Symbol e.g. ZECUSDT"
          aria-label="Pair symbol (optional)"
        />
        <select id="filterSymbol" class="input" aria-label="Filter displayed pairs">
          <option value="">All pairs</option>
        </select>
        <input
          id="lookbackDays"
          class="input"
          type="number"
          value="3"
          min="0.1"
          step="0.1"
          aria-label="Lookback days"
        />
        <input
          id="speedMultiplier"
          class="input"
          type="number"
          value="24"
          min="1"
          step="1"
          aria-label="Time acceleration multiplier"
        />
        <label style="display:flex;align-items:center;gap:6px;color:var(--muted);font-weight:600;">
          <input id="useProxy" type="checkbox" />
          Use CORS proxy
        </label>
        <button id="startSim">Simulate</button>
        <button id="refresh">Refresh</button>
        <button id="pauseAll" class="btn-danger">Pause all</button>
        <button id="resumeAll" class="btn-secondary">Resume all</button>
        <button id="stopSim" class="btn-danger">Stop simulation</button>
        <button id="exportCsv" class="btn-secondary">Export CSV</button>
      </div>
    </header>

    <div id="meta" class="muted">Waiting for data...</div>
    <div class="error" id="error" hidden></div>

    <div class="card-grid">
      <div class="card">
        <h3>Realized PnL</h3>
        <div class="value" id="realized">-</div>
        <div class="pill" id="realizedCount">0 pairs</div>
      </div>
      <div class="card">
        <h3>Unrealized PnL</h3>
        <div class="value" id="unrealized">-</div>
        <div class="pill" id="unrealizedCount">0 pairs</div>
      </div>
      <div class="card">
        <h3>Total PnL</h3>
        <div class="value" id="totalPnl">-</div>
        <div class="pill" id="pnlSummary">-</div>
      </div>
      <div class="card">
        <h3>Net PnL (after quote fees)</h3>
        <div class="value" id="netPnl">-</div>
        <div class="pill" id="netPnlMeta">Realized net / fees</div>
      </div>
      <div class="card">
        <h3>Strategy PnL mix</h3>
        <div class="value" id="strategyPnl">-</div>
        <div class="pill" id="strategyPnlMeta">Ladder / Micro</div>
      </div>
      <div class="card">
        <h3>Strategy fees</h3>
        <div class="value" id="strategyFees">-</div>
        <div class="pill" id="strategyFeesMeta">Quote / BNB</div>
      </div>
      <div class="card">
        <h3>Paused pairs</h3>
        <div class="value" id="pausedCount">0</div>
        <div class="pill" id="totalCount">0 pairs total</div>
      </div>
      <div class="card">
        <h3>Total quote used</h3>
        <div class="value" id="quoteSpent">-</div>
        <div class="pill" id="ladderInfo">-</div>
      </div>
      <div class="card">
        <h3>Profit reserve</h3>
        <div class="value" id="reserveCoin">-</div>
        <div class="pill" id="reserveCoinMeta">Pending/held</div>
      </div>
      <div class="card">
        <h3>BNB reserve</h3>
        <div class="value" id="reserveBnb">-</div>
        <div class="pill" id="reserveBnbMeta">Pending/held</div>
      </div>
      <div class="card">
        <h3>Fees paid</h3>
        <div class="value" id="feesPaid">-</div>
        <div class="pill" id="feesMeta">Quote / BNB</div>
      </div>
    </div>

    <div class="card">
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Phase</th>
              <th>Price</th>
              <th>Position (Qty)</th>
              <th>Avg</th>
              <th>Unrealized</th>
              <th>Realized Total</th>
              <th>Cumulative PnL</th>
              <th>Profit reserve</th>
              <th>BNB reserve</th>
              <th>Fees</th>
              <th>Next (Buy/Sell)</th>
              <th>Micro</th>
              <th>Ladder</th>
              <th>Status</th>
              <th>Exit</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
          <tfoot>
            <tr id="totalsRow"></tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top: 16px;">
      <h3>Adaptive Buy-the-Dip / Sell-the-Rip</h3>
      <p class="muted">Concise, per-symbol guidance for dip entries, rip exits, fast swings, ladder ammo, and profit reserves.</p>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Entry trigger</th>
              <th>Exit plan</th>
              <th>Quick swing note</th>
              <th>Ammo / ladder</th>
              <th>Profit stash</th>
            </tr>
          </thead>
          <tbody id="planRows"></tbody>
        </table>
      </div>
    </div>

    <div class="card log-wrapper">
      <div class="log-header">
        <h3 style="margin:0;">Recent activity</h3>
        <div class="pill" id="logMeta">-</div>
      </div>
      <div class="log-feed" id="logFeed" aria-live="polite"></div>
    </div>

    <div class="footer">
      <span class="pill">Data from /health</span>
      <span id="lastUpdated">-</span>
    </div>
  </div>

  <script>
    const apiBaseEl = document.getElementById("apiBase");
    const rowsEl = document.getElementById("rows");
    const planRowsEl = document.getElementById("planRows");
    const logFeedEl = document.getElementById("logFeed");
    const logMetaEl = document.getElementById("logMeta");
    const errorEl = document.getElementById("error");
    const metaEl = document.getElementById("meta");
    const proxyToggle = document.getElementById("useProxy");
    const pairSymbolEl = document.getElementById("pairSymbol");
    const filterSymbolEl = document.getElementById("filterSymbol");
    const lookbackEl = document.getElementById("lookbackDays");
    const speedEl = document.getElementById("speedMultiplier");
    const startBtn = document.getElementById("startSim");
    const proxyPrefKey = "bb_use_proxy";
    let lastData = null;

    const defaultApiBase = (() => {
      const { protocol, hostname } = window.location;
      if (protocol.startsWith("http") && hostname) {
        const baseHost = hostname.replace(/:+$/, "");
        return `${protocol}//${baseHost}:8082`;
      }
      return "http://45.154.25.16:8082";
    })();

    if (!apiBaseEl.value || apiBaseEl.value.includes("45.154.25.16")) {
      apiBaseEl.value = defaultApiBase;
    }

    function fmtNumber(value, digits = 2) {
      if (value === null || value === undefined || Number.isNaN(value)) return "-";
      const abs = Math.abs(value);
      let d = digits;
      if (abs < 1) d = Math.max(digits, 6);
      else if (abs < 100) d = Math.max(digits, 4);
      else if (abs >= 1000) d = 2;
      return Number(value).toLocaleString(undefined, { minimumFractionDigits: d, maximumFractionDigits: d });
    }

    function fmtPercent(value, digits = 2) {
      if (value === null || value === undefined || Number.isNaN(value)) return null;
      return `${fmtNumber(value, digits)}%`;
    }

    function sum(values) {
      return values.reduce((acc, v) => acc + (typeof v === "number" ? v : 0), 0);
    }

    function aggregateReserves(entries, keys = []) {
      return entries.reduce((acc, [, v]) => {
        const res = keys.map((k) => v[k]).find(Boolean) || {};
        if (typeof res.quote === "number") acc.quote = (acc.quote || 0) + res.quote;
        if (typeof res.coin === "number") acc.coin = (acc.coin || 0) + res.coin;
        return acc;
      }, {});
    }

    function aggregateFees(entries) {
      return entries.reduce((acc, [, v]) => {
        const fees = v.fees_paid?.pair || v.fees_paid?.totals || v.fees_paid;
        if (typeof fees?.quote === "number") acc.quote = (acc.quote || 0) + fees.quote;
        if (typeof fees?.bnb === "number") acc.bnb = (acc.bnb || 0) + fees.bnb;
        return acc;
      }, {});
    }

    function formatGap(targetPrice, currentPrice) {
      if (typeof targetPrice !== "number") return "-";
      const pct = typeof currentPrice === "number" && currentPrice > 0
        ? ((targetPrice - currentPrice) / currentPrice) * 100
        : null;
      const pctLabel = fmtPercent(pct);
      return pctLabel ? `${fmtNumber(targetPrice)} (${pctLabel})` : fmtNumber(targetPrice);
    }

    function reserveLabel(reserve, { compact = false } = {}) {
      if (!reserve) return "-";
      const symbol = reserve.symbol || "COIN";
      const pending = fmtNumber(reserve.pending_quote ?? 0, 2);
      const holdings = fmtNumber(reserve.holdings_qty ?? 0, 4);
      const spent = reserve.quote_spent ? fmtNumber(reserve.quote_spent, 2) : null;
      if (compact) return `${symbol} q:${pending} h:${holdings}`;
      const parts = [`Pending ${pending}q`, `Hold ${holdings}`];
      if (spent) parts.push(`Spent ${spent}q`);
      return `${symbol} ${parts.join(" / ")}`;
    }

    function ladderBadges(legs, currentPrice) {
      if (!Array.isArray(legs) || !legs.length) return "";
      const filled = legs.filter((leg) => leg.filled).length;
      const summaryText = `View ladder (${filled}/${legs.length} filled)`;
      const items = legs.map((leg) => {
        const cls = leg.filled ? "ladder-badge filled" : "ladder-badge";
        const price = fmtNumber(leg.price);
        const quote = fmtNumber(leg.quote, 2);
        const pct = typeof currentPrice === "number" && currentPrice > 0
          ? ((leg.price - currentPrice) / currentPrice) * 100
          : null;
        const pctLabel = fmtPercent(pct);
        const pctText = pctLabel ? ` (${pctLabel})` : "";
        return `<span class="${cls}" title="Step ${leg.idx}: ${price} / ${quote} quote">#${leg.idx} ${price}${pctText}</span>`;
      });
      return `
        <details class="ladder-steps">
          <summary>${summaryText}</summary>
          <div class="ladder-badges">${items.join("")}</div>
        </details>`;
    }
// ทบทวน function feesLabel ว่าถูกไหม
    function feesLabel(fees) {
      if (!fees) return "-";
      const quote = fmtNumber(fees.quote ?? 0, 4);
      const bnb = fmtNumber(fees.bnb ?? 0, 4);
      const other = fees.other && Object.keys(fees.other).length
        ? `Other ${Object.entries(fees.other)
            .map(([k, v]) => `${k}:${fmtNumber(v, 4)}`)
            .join(", ")}`
        : null;
      return other ? `${quote} q / ${bnb} bnb (${other})` : `${quote} q / ${bnb} bnb`;
    }

    function feesStrategyLabel(fees) {
      if (!fees?.by_strategy) return "";
      const ladder = fees.by_strategy.ladder || {};
      const micro = fees.by_strategy.micro || {};
      const ladderText = `L q:${fmtNumber(ladder.quote ?? 0, 4)} b:${fmtNumber(ladder.bnb ?? 0, 4)}`;
      const microText = `M q:${fmtNumber(micro.quote ?? 0, 4)} b:${fmtNumber(micro.bnb ?? 0, 4)}`;
      return `${ladderText} | ${microText}`;
    }

    function pnlBreakdownLabel(breakdown) {
      if (!breakdown) return "";
      const realized = breakdown.realized || {};
      const unrealized = breakdown.unrealized || {};
      const lR = fmtNumber(realized.ladder ?? 0, 2);
      const mR = fmtNumber(realized.micro ?? 0, 2);
      const lU = fmtNumber(unrealized.ladder ?? 0, 2);
      const mU = fmtNumber(unrealized.micro ?? 0, 2);
      return `L r ${lR} / u ${lU} | M r ${mR} / u ${mU}`;
    }

    function planRow(symbol, v) {
      const hasBtdTarget = typeof v.btd_target_price === "number";
      const entryTarget = hasBtdTarget ? v.btd_target_price : v.next_buy_price;
      const entryLabel = hasBtdTarget ? "Dip trigger" : "Next buy";
      const entryText = entryTarget
        ? `${entryLabel} ≤ ${formatGap(entryTarget, v.price)}`
        : "Waiting for buy target";

      const exitText = v.next_sell_price
        ? `Scale out ≥ ${formatGap(v.next_sell_price, v.price)}`
        : "Waiting for sell target";

      const swingStateRaw = v.micro_state || (v.micro_positions > 0 ? "waiting_sell" : "idle");
      const swingState = swingStateRaw.replace(/_/g, " ");
      const swingParts = [
        `Micro ${swingState}`,
        `Next b ${v.micro_next_buy_price ? fmtNumber(v.micro_next_buy_price) : "-"}`,
        `Next s ${v.micro_next_sell_price ? fmtNumber(v.micro_next_sell_price) : "-"}`,
        `Swings ${v.micro_swings ?? 0}`
      ];
      const swingText = swingParts.join(" · ");

      const ladderFilled = Array.isArray(v.ladder_legs)
        ? v.ladder_legs.filter((leg) => leg.filled).length
        : typeof v.ladder_index === "number"
          ? Math.min(v.ladder_index, v.ladder_total || 0)
          : 0;
      const ladderTotal = Array.isArray(v.ladder_legs)
        ? v.ladder_legs.length
        : v.ladder_total;
      const ladderParts = [];
      if (ladderTotal) ladderParts.push(`${ladderFilled}/${ladderTotal} ladder filled`);
      if (v.ladder_next_quote) ladderParts.push(`Next quote ${fmtNumber(v.ladder_next_quote, 2)}`);
      const ammoText = ladderParts.length ? ladderParts.join(" · ") : "Ladder idle";

      const profitReserve = v.profit_reserve || v.profit_reserve_coin;
      const profitText = profitReserve
        ? `Holding ${reserveLabel(profitReserve, { compact: true })}`
        : "No profit reserve yet";

      return `
        <tr>
          <td><strong>${symbol}</strong></td>
          <td>${entryText}</td>
          <td>${exitText}</td>
          <td>${swingText}</td>
          <td>${ammoText}</td>
          <td>${profitText}</td>
        </tr>`;
    }

    function apiUrl(path) {
      const base = apiBaseEl.value.replace(/\/$/, "");
      const useProxy = proxyToggle?.checked;
      const full = `${base}${path}`;
      if (!useProxy) return full;

      // Encode to avoid proxy blocking when the URL contains query params or protocol prefixes
      const encoded = encodeURIComponent(full);
      return `https://corsproxy.io/?${encoded}`;
    }

    async function postCommand(path) {
      const resp = await fetch(apiUrl(path), { method: "POST" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return resp.json();
    }

    async function fetchHealth({ retriedWithProxy = false, retriedWithoutProxy = false } = {}) {
      errorEl.hidden = true;
      metaEl.textContent = "Loading data...";
      try {
        const usingProxy = proxyToggle?.checked;
        const resp = await fetch(apiUrl("/health"));
        if (!resp.ok) {
          if (usingProxy && resp.status === 403 && !retriedWithoutProxy) {
            proxyToggle.checked = false;
            persistProxyPref();
            return fetchHealth({ retriedWithProxy, retriedWithoutProxy: true });
          }
          throw new Error(`HTTP ${resp.status}`);
        }
        const data = await resp.json();
        lastData = data;
        render(data);
      } catch (err) {
        console.error(err);
        if (shouldAutoEnableProxy({ retriedWithProxy })) {
          proxyToggle.checked = true;
          persistProxyPref();
          return fetchHealth({ retriedWithProxy: true });
        }
        const proxyHint = proxyToggle?.checked
          ? "CORS proxy is enabled; if you still see HTTP 403/404, try disabling it and reloading."
          : "If loading from a local file, enable the CORS proxy toggle.";
        errorEl.textContent = `Failed to fetch data: ${err.message}. ${proxyHint}`;
        errorEl.hidden = false;
        metaEl.textContent = "Error";
      }
    }

    function shouldAutoEnableProxy({ retriedWithProxy }) {
      const isFile = window.location.protocol === "file:";
      return isFile && !retriedWithProxy && proxyToggle && !proxyToggle.checked;
    }

    function loadProxyPref() {
      const raw = window.localStorage.getItem(proxyPrefKey);
      if (raw === null) {
        proxyToggle.checked = window.location.protocol === "file:";
        return;
      }
      proxyToggle.checked = raw === "true";
    }

    function persistProxyPref() {
      if (!proxyToggle) return;
      window.localStorage.setItem(proxyPrefKey, String(proxyToggle.checked));
    }

    function syncFilterOptions(entries) {
      if (!filterSymbolEl) return;
      const current = filterSymbolEl.value;
      const symbols = entries.map(([symbol]) => symbol).sort();
      const options = ["<option value=\"\">All pairs</option>", ...symbols.map((sym) => `<option value="${sym}">${sym}</option>`)];
      filterSymbolEl.innerHTML = options.join("");
      filterSymbolEl.value = symbols.includes(current) ? current : "";
    }

    function render(data) {
      const pairs = data.pairs || {};
      const entries = Object.entries(pairs);
      syncFilterOptions(entries);
      const filterSymbol = (filterSymbolEl?.value || "").trim();
      const filteredEntries = filterSymbol ? entries.filter(([symbol]) => symbol === filterSymbol) : entries;
      const totals = filterSymbol ? {} : data.totals || {};
      const now = new Date().toLocaleString();
      document.getElementById("lastUpdated").textContent = `Last updated: ${now}`;
      metaEl.textContent = filterSymbol
        ? `${filteredEntries.length}/${entries.length} pairs (filter ${filterSymbol}) | status: ${data.status}`
        : `${entries.length} pairs | status: ${data.status}`;

      const unrealizedList = filteredEntries.map(([, v]) => v.unrealized_pnl).filter((v) => v !== null && v !== undefined);
      const realizedList = filteredEntries.map(([, v]) => v.realized_pnl_total ?? v.realized_pnl).filter((v) => v !== null && v !== undefined);
      const quoteSpent = sum(filteredEntries.map(([, v]) => v.quote_spent));
      const totalQty = sum(filteredEntries.map(([, v]) => v.qty));
      const paused = filteredEntries.filter(([, v]) => v.paused).length;
      const ladderInfo = filteredEntries.map(([, v]) => v.ladder_total || 0);

      const unrealized = typeof totals.unrealized_pnl === "number" ? totals.unrealized_pnl : sum(unrealizedList);
      const realized = typeof totals.realized_pnl === "number" ? totals.realized_pnl : sum(realizedList);
      const totalPnl = typeof totals.pnl_total === "number" ? totals.pnl_total : realized + unrealized;
      const totalBreakdown = totals.pnl_breakdown || {
        realized: { ladder: realized, micro: 0 },
        unrealized: { ladder: unrealized, micro: 0 },
        totals: { ladder: realized + unrealized, micro: 0 },
      };
      const ladderRealized = totalBreakdown.realized?.ladder ?? realized;
      const microRealized = totalBreakdown.realized?.micro ?? 0;
      const ladderUnrealized = totalBreakdown.unrealized?.ladder ?? 0;
      const microUnrealized = totalBreakdown.unrealized?.micro ?? 0;
      const totalBreakdownText = pnlBreakdownLabel(totalBreakdown);

      document.getElementById("unrealized").innerHTML = formatPnl(unrealized);
      document.getElementById("unrealizedCount").textContent = `${unrealizedList.length} pairs with position`;
      document.getElementById("realized").innerHTML = formatPnl(realized);
      document.getElementById("realizedCount").textContent = `${realizedList.length} pairs with realized PnL`;
      document.getElementById("totalPnl").innerHTML = formatPnl(totalPnl);
      document.getElementById("pnlSummary").textContent =
        `r ${fmtNumber(realized, 2)} / u ${fmtNumber(unrealized, 2)} | L r ${fmtNumber(ladderRealized, 2)} u ${fmtNumber(ladderUnrealized, 2)} | M r ${fmtNumber(microRealized, 2)} u ${fmtNumber(microUnrealized, 2)}`;
      document.getElementById("pausedCount").textContent = paused;
      document.getElementById("totalCount").textContent = `${entries.length} pairs total`;
      document.getElementById("quoteSpent").textContent = `${fmtNumber(quoteSpent, 2)} USDT`;
      document.getElementById("ladderInfo").textContent = `Max ladder steps: ${Math.max(0, ...ladderInfo)}`;

      const totalReserves = totals.profit_reserve || aggregateReserves(filteredEntries, ["profit_reserve", "profit_reserve_coin"]);
      document.getElementById("reserveCoin").textContent = reserveLabel(totalReserves, { compact: true });
      document.getElementById("reserveCoinMeta").textContent = reserveLabel(totalReserves);
      const totalBnb = totals.bnb_reserve || aggregateReserves(filteredEntries, ["bnb_reserve", "bnb_reserve_for_fees"]);
      document.getElementById("reserveBnb").textContent = reserveLabel(totalBnb, { compact: true });
      document.getElementById("reserveBnbMeta").textContent = reserveLabel(totalBnb);

      const feeTotals = totals.fees_paid || aggregateFees(filteredEntries);
      document.getElementById("feesPaid").textContent = feesLabel(feeTotals);
      const feeSplitText = feesStrategyLabel(feeTotals);
      const feeMetaBase = `Quote ${fmtNumber(feeTotals.quote ?? 0, 4)} / BNB ${fmtNumber(feeTotals.bnb ?? 0, 4)}`;
      document.getElementById("feesMeta").textContent = feeSplitText ? `${feeMetaBase} | ${feeSplitText}` : feeMetaBase;

      const quoteFees = feeTotals.quote ?? 0;
      const netRealized = realized - quoteFees;
      const netTotal = totalPnl - quoteFees;
      document.getElementById("netPnl").innerHTML = formatPnl(netTotal);
      document.getElementById("netPnlMeta").textContent =
        `r ${fmtNumber(netRealized, 2)} | fees q ${fmtNumber(quoteFees, 4)} b ${fmtNumber(feeTotals.bnb ?? 0, 4)} (BNB not converted)`;

      const ladderTotalPnl = totalBreakdown.totals?.ladder ?? ladderRealized + ladderUnrealized;
      const microTotalPnl = totalBreakdown.totals?.micro ?? microRealized + microUnrealized;
      document.getElementById("strategyPnl").textContent = `L ${fmtNumber(ladderTotalPnl, 2)} / M ${fmtNumber(microTotalPnl, 2)}`;
      document.getElementById("strategyPnlMeta").textContent =
        `L r ${fmtNumber(ladderRealized, 2)} u ${fmtNumber(ladderUnrealized, 2)} | ` +
        `M r ${fmtNumber(microRealized, 2)} u ${fmtNumber(microUnrealized, 2)}`;

      const strategyFees = feeTotals.by_strategy || {};
      const strategyFeeLabel = feesStrategyLabel({ by_strategy: strategyFees });
      const ladderFees = strategyFees.ladder || {};
      const microFees = strategyFees.micro || {};
      const ladderFeeText = `L q:${fmtNumber(ladderFees.quote ?? 0, 4)} b:${fmtNumber(ladderFees.bnb ?? 0, 4)}`;
      const microFeeText = `M q:${fmtNumber(microFees.quote ?? 0, 4)} b:${fmtNumber(microFees.bnb ?? 0, 4)}`;
      document.getElementById("strategyFees").textContent = strategyFeeLabel || `${ladderFeeText} | ${microFeeText}`;
      const strategyFeeMeta = `Tot q ${fmtNumber(feeTotals.quote ?? 0, 4)} / bnb ${fmtNumber(feeTotals.bnb ?? 0, 4)}`;
      document.getElementById("strategyFeesMeta").textContent = strategyFeeLabel ? `${strategyFeeMeta} | ${strategyFeeLabel}` : strategyFeeMeta;

      const lastSellBySymbol = new Map();
      (Array.isArray(data.logs) ? data.logs : []).forEach((entry) => {
        const symbol = (entry.symbol || "").toUpperCase();
        if (!symbol) return;
        const kind = String(entry.side || entry.kind || entry.event || entry.msg || "").toUpperCase();
        if (!/SELL/.test(kind)) return;
        const ts = entry.ts || entry.timestamp || entry.time;
        const prev = lastSellBySymbol.get(symbol);
        if (!prev || (ts && new Date(ts).getTime() > new Date(prev).getTime())) {
          lastSellBySymbol.set(symbol, ts);
        }
      });

      rowsEl.innerHTML = filteredEntries
        .map(([symbol, v]) => {
          const statusClass = v.paused ? "paused" : "live";
          const statusText = v.paused ? "Paused" : "Live";
          const unrealizedCell = v.unrealized_pnl === null ? "-" : formatPnl(v.unrealized_pnl);
          const nextSell = v.next_sell_price ? fmtNumber(v.next_sell_price) : "-";
          const nextBuy = formatGap(v.next_buy_price, v.price);
          const buyTheDip = v.btd_armed ? formatGap(v.btd_target_price, v.price) : "-";
          const ladder =
            typeof v.ladder_index === "number" && typeof v.ladder_total === "number"
              ? `${Math.min(v.ladder_index, v.ladder_total)}/${v.ladder_total}`
              : "-";
          const ladderNextQuote = v.ladder_next_quote ? fmtNumber(v.ladder_next_quote, 2) : "-";
      const ladderBadgesHtml = ladderBadges(v.ladder_legs, v.price);
      const actionLabel = v.paused ? "Resume" : "Pause";
      const actionClass = v.paused ? "btn-secondary" : "btn-danger";
      const realizedPnl = v.realized_pnl_total ?? v.realized_pnl ?? 0;
      const cumulativePnl = typeof v.pnl_total === "number" ? v.pnl_total : realizedPnl + (v.unrealized_pnl || 0);
      const breakdown = v.pnl_breakdown || {
        realized: { ladder: realizedPnl, micro: 0 },
        unrealized: { ladder: v.unrealized_pnl || 0, micro: 0 },
        totals: { ladder: cumulativePnl, micro: 0 },
      };
      const ladderRealizedPair = breakdown.realized?.ladder ?? realizedPnl;
      const microRealizedPair = breakdown.realized?.micro ?? 0;
      const ladderUnrealizedPair = breakdown.unrealized?.ladder ?? (v.unrealized_pnl || 0);
      const microUnrealizedPair = breakdown.unrealized?.micro ?? 0;
      const ladderTotalPair = breakdown.totals?.ladder ?? ladderRealizedPair + ladderUnrealizedPair;
      const microTotalPair = breakdown.totals?.micro ?? microRealizedPair + microUnrealizedPair;
      const exitLabel = (v.unrealized_pnl || 0) >= 0 ? "Take profit" : "Cut loss";
      const exitClass = (v.unrealized_pnl || 0) >= 0 ? "" : "btn-danger";
      const hasPosition = (v.qty || 0) > 0;
      const takeProfitHint = hasPosition
        ? ((v.unrealized_pnl || 0) >= 0 ? "Take profit ready" : "Hold for recovery")
        : "No position";
      const lastSellTs = lastSellBySymbol.get(symbol);
      const lastSellLabel = lastSellTs ? `Last sell ${formatTime(lastSellTs)}` : "Last sell -";
      const exitDisabled = hasPosition ? "" : "disabled";
      const exitTitle = hasPosition
        ? "Sell now at market (includes ~0.1% fee)"
        : "No open position to exit";
      const profitReserve = v.profit_reserve || v.profit_reserve_coin;
      const bnbReserve = v.bnb_reserve || v.bnb_reserve_for_fees;
      const pairFees = v.fees_paid?.pair ?? v.fees_paid?.totals ?? v.fees_paid;
      const feeSplitPair = feesStrategyLabel({ by_strategy: v.fees_paid?.pair?.by_strategy || v.fees_paid?.by_strategy });
      const microStateRaw = v.micro_state || (v.micro_positions > 0 ? "waiting_sell" : "idle");
      const microState = microStateRaw.replace(/_/g, " ");
      const microPos = fmtNumber(v.micro_position_qty, 6);
      const microSwings = v.micro_swings ?? 0;
      const microNextBuy = v.micro_next_buy_price ? fmtNumber(v.micro_next_buy_price) : "-";
      const microNextSell = v.micro_next_sell_price ? fmtNumber(v.micro_next_sell_price) : "-";
      const microCool = v.micro_cooldown_until_bar ?? "-";
      const microCell = `
        <div class="muted">${microState}</div>
        <div class="muted">Pos ${microPos} / swings ${microSwings}</div>
        <div class="muted">Next buy ${microNextBuy}</div>
        <div class="muted">Next sell ${microNextSell}</div>
        <div class="muted">CD bar ${microCool}</div>`;

          return `
            <tr>
              <td><strong>${symbol}</strong><div class="muted timestamp">${v.timestamp ?? ""}</div></td>
              <td class="phase">${v.phase || "-"}</td>
              <td>${fmtNumber(v.price)}</td>
              <td>${fmtNumber(v.qty, 6)}<div class="muted">Spent ${fmtNumber(v.quote_spent, 6)} quote</div></td>
              <td>${v.avg_price ? fmtNumber(v.avg_price) : "-"}</td>
              <td class="${pnlClass(v.unrealized_pnl)}">${v.unrealized_pnl === null ? "-" : `${unrealizedCell}<div class=\"muted\">L ${fmtNumber(ladderUnrealizedPair, 2)} / M ${fmtNumber(microUnrealizedPair, 2)}</div>`}</td>
              <td class="${pnlClass(realizedPnl)}">${formatPnl(realizedPnl)}<div class="muted">L ${fmtNumber(ladderRealizedPair, 2)} / M ${fmtNumber(microRealizedPair, 2)}</div></td>
               <td class="${pnlClass(cumulativePnl)}">${formatPnl(cumulativePnl)}<div class="muted">L ${fmtNumber(ladderTotalPair, 2)} / M ${fmtNumber(microTotalPair, 2)}</div></td>
              <td>${reserveLabel(profitReserve, { compact: true })}</td>
              <td>${reserveLabel(bnbReserve, { compact: true })}</td>
              <td>${feesLabel(pairFees)}${feeSplitPair ? `<div class="muted">${feeSplitPair}</div>` : ""}</td>
              <td><div class="muted">Buy: ${nextBuy}</div><div class="muted">BTD: ${buyTheDip}</div><div class="muted">Sell: ${nextSell}</div></td>
              <td>${microCell}</td>
              <td>${ladder}<div class="muted">Next q: ${ladderNextQuote}</div>${ladderBadgesHtml}</td>
              <td>
                <span class="status ${statusClass}">${statusText}</span>
                <div class="muted">${takeProfitHint}</div>
                <div class="muted">${lastSellLabel}</div>
              </td>
              <td><button class="${exitClass}" data-action="exit" data-symbol="${symbol}" aria-label="${exitLabel}" title="${exitTitle}" ${exitDisabled}>${exitLabel}</button></td>
              <td><button class="${actionClass}" data-action="toggle" data-symbol="${symbol}" data-paused="${v.paused}">${actionLabel}</button></td>
            </tr>`;
        })
        .join("");

      planRowsEl.innerHTML = filteredEntries.map(([symbol, v]) => planRow(symbol, v)).join("");

      renderLogs(data.logs || [], filterSymbol);

      const totalsRow = document.getElementById("totalsRow");
      totalsRow.innerHTML = `
        <td><strong>ALL</strong></td>
        <td class="phase">-</td>
        <td>-</td>
        <td>${fmtNumber(totalQty, 6)}<div class="muted">Spent ${fmtNumber(quoteSpent, 6)} quote</div></td>
        <td>-</td>
        <td class="${pnlClass(unrealized)}">${formatPnl(unrealized)}</td>
        <td class="${pnlClass(realized)}">${formatPnl(realized)}</td>
        <td class="${pnlClass(totalPnl)}">${formatPnl(totalPnl)}<div class="muted">${totalBreakdownText}</div></td>
        <td>${reserveLabel(totalReserves, { compact: true })}</td>
        <td>${reserveLabel(totalBnb, { compact: true })}</td>
        <td>${feesLabel(feeTotals)}${feeSplitText ? `<div class="muted">${feeSplitText}</div>` : ""}</td>
        <td colspan="6" class="muted">Aggregated totals</td>
      `;
    }

    function pnlClass(val) {
      if (val === null || val === undefined) return "muted";
      return val >= 0 ? "pnl-pos" : "pnl-neg";
    }

    function formatPnl(val) {
      if (val === null || val === undefined) return "-";
      const cls = val >= 0 ? "pnl-pos" : "pnl-neg";
      return `<span class="${cls}">${fmtNumber(val, 2)}</span>`;
    }

    const escapeHtml = (value) => String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");

    const formatTime = (ts) => (ts ? new Date(ts).toLocaleTimeString([], { hour12: false }) : "-");

    const formatRange = (firstTs, lastTs) => {
      const start = formatTime(firstTs);
      const end = formatTime(lastTs);
      if (!firstTs || !lastTs || start === end) return start;
      return `${start}–${end}`;
    };

    const categorizeLog = (kind, reasonText = "") => {
      const text = `${kind} ${reasonText}`.toLowerCase();
      if (/order|fill|buy|sell|txn|filled/.test(text)) return "trade";
      if (/ladder|anchor/.test(text)) return "ladder";
      if (/micro/.test(text)) return "micro";
      if (/pause|resume|start|status/.test(text)) return "status";
      if (/error|fail|alert|pullback|cut/.test(text)) return "alert";
      return "info";
    };

    function renderLogs(logs, filterSymbol = "") {
      if (!logFeedEl || !logMetaEl) return;
      const items = Array.isArray(logs) ? logs.slice(-1000) : [];
      const symbol = filterSymbol?.trim();
      const filtered = symbol ? items.filter((entry) => (entry.symbol || "").toUpperCase() === symbol.toUpperCase()) : items;
      const collapseWindowMs = 2 * 60 * 1000; // merge repeating noise within 2 minutes

      const condensed = filtered.map((entry) => {
        const symbol = entry.symbol || "";
        const kind = entry.kind ? String(entry.kind).toUpperCase() : "";
        const side = entry.side ? String(entry.side).toUpperCase() : "";
        const baseKind = side || kind || "EVENT";
        const qty = typeof entry.qty === "number" ? `q${fmtNumber(entry.qty, 6)}` : "";
        const price = typeof entry.price === "number" ? `@${fmtNumber(entry.price)}` : "";
        const notional = typeof entry.notional === "number" ? `n${fmtNumber(entry.notional, 4)}` : "";
        const pnlVal = typeof entry.pnl === "number" ? entry.pnl : null;
        const pnlText = pnlVal === null ? "" : `pnl=${fmtNumber(pnlVal, 6)}`;
        const reason = [entry.msg, entry.status].filter(Boolean).join(" | ");
        const detailText = [qty, price, notional].filter(Boolean).join(" ");
        const label = [baseKind, reason].filter(Boolean).join(": ");
        const suffix = [detailText, pnlText].filter(Boolean).join("  ");
        const summary = [label, suffix].filter(Boolean).join(" • ");
        const key = [symbol, label, suffix].filter(Boolean).join("|");
        const category = categorizeLog(baseKind, reason || suffix);
        const humanSymbol = symbol || "MARKET";
        return { ts: entry.ts, symbol: humanSymbol, summary, key, label: baseKind, reason, detail: suffix, category };
      });

      const lastByKey = new Map();
      const deduped = condensed.reduce((acc, item) => {
        const priorIndex = lastByKey.get(item.key);
        const prior = typeof priorIndex === "number" ? acc[priorIndex] : undefined;
        const withinWindow =
          prior && typeof item.ts === "number" && typeof prior.lastTs === "number"
            ? Math.abs(item.ts - prior.lastTs) <= collapseWindowMs
            : false;

        if (prior && withinWindow) {
          prior.count += 1;
          prior.lastTs = item.ts || prior.lastTs;
          return acc;
        }

        const nextIndex = acc.length;
        acc.push({
          ...item,
          count: 1,
          firstTs: item.ts,
          lastTs: item.ts,
        });
        lastByKey.set(item.key, nextIndex);
        return acc;
      }, []);

      const lines = deduped.map((entry) => {
        const timeLabel = formatRange(entry.firstTs, entry.lastTs);
        const countBadge = entry.count > 1 ? `<span class="count">x${entry.count}</span>` : "";
        return `
          <div class="log-line">
            <span class="timestamp">${escapeHtml(timeLabel)}</span>
            <span class="log-badge ${entry.category}">${escapeHtml(entry.label)}</span>
            <span class="sym">${escapeHtml(entry.symbol)}</span>
            <span class="meta">${escapeHtml(entry.reason || entry.summary)}</span>
            ${entry.detail ? `<span class="meta">${escapeHtml(entry.detail)}</span>` : ""}
            ${countBadge}
          </div>`;
      });

      const filterMeta = symbol ? ` | filter ${symbol}` : "";
      logMetaEl.textContent = `${deduped.length} grouped from ${filtered.length} recent (latest 1000, 2m dedup window${filterMeta})`;
      logFeedEl.innerHTML = lines.join("\n");
    }

    rowsEl.addEventListener("click", async (ev) => {
      const btn = ev.target.closest("button[data-symbol]");
      if (!btn) return;
      const symbol = btn.dataset.symbol;
      const action = btn.dataset.action;
      if (action === "exit") {
        const confirmMsg = `Sell ${symbol} now at market? (~0.1% fee applied)`;
        if (!window.confirm(confirmMsg)) return;
        btn.disabled = true;
        btn.textContent = "Selling...";
        try {
          await postCommand(`/sell?symbol=${symbol}`);
          await fetchHealth();
        } catch (err) {
          alert(`Command failed: ${err.message}`);
        } finally {
          btn.disabled = false;
        }
        return;
      }

      const paused = btn.dataset.paused === "true";
      btn.disabled = true;
      btn.textContent = paused ? "Resuming..." : "Pausing...";
      try {
        await postCommand(paused ? `/resume?symbol=${symbol}` : `/pause?symbol=${symbol}`);
        await fetchHealth();
      } catch (err) {
        alert(`Command failed: ${err.message}`);
      } finally {
        btn.disabled = false;
      }
    });

    startBtn?.addEventListener("click", async () => {
      const lookback = Number(lookbackEl?.value) || 3;
      const speed = Number(speedEl?.value) || 24;
      const symbol = pairSymbolEl?.value?.trim();
      const payload = { lookback_days: lookback, speed };
      if (symbol) payload.symbol = symbol;

      startBtn.disabled = true;
      const prevText = startBtn.textContent;
      startBtn.textContent = "Starting...";
      try {
        const resp = await fetch(apiUrl("/start"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        await fetchHealth();
      } catch (err) {
        alert(`Start failed: ${err.message}`);
      } finally {
        startBtn.disabled = false;
        startBtn.textContent = prevText;
      }
    });

    document.getElementById("pauseAll").addEventListener("click", async () => {
      try {
        await postCommand("/pause");
        await fetchHealth();
      } catch (err) {
        alert(`Pause failed: ${err.message}`);
      }
    });

    document.getElementById("resumeAll").addEventListener("click", async () => {
      try {
        await postCommand("/resume");
        await fetchHealth();
      } catch (err) {
        alert(`Resume failed: ${err.message}`);
      }
    });

    document.getElementById("stopSim").addEventListener("click", async () => {
      try {
        await postCommand("/stop");
        await fetchHealth();
      } catch (err) {
        alert(`Stop failed: ${err.message}`);
      }
    });

    document.getElementById("exportCsv").addEventListener("click", async () => {
      try {
        const resp = await fetch(apiUrl("/export"));
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "simulation_trades.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        alert(`Export failed: ${err.message}`);
      }
    });

    document.getElementById("refresh").addEventListener("click", () => fetchHealth());
    proxyToggle?.addEventListener("change", () => {
      persistProxyPref();
      fetchHealth();
    });
    filterSymbolEl?.addEventListener("change", () => {
      if (lastData) render(lastData);
    });

    loadProxyPref();
    fetchHealth();
    setInterval(() => fetchHealth(), 10000);
  </script>
</body>
</html>
