# พฤติกรรมของบอทตาม `config.yaml`

ไฟล์นี้สรุปว่า config ปัจจุบันจะทำงานอย่างไร ทั้งฝั่งซื้อ–สะสม (ladder + dip + scalp) และฝั่งขาย (take-profit trail + sell_at_height + scale-out) พร้อมตัวอย่างเส้นทางราคา 10–15 ไม้ให้เห็นภาพรวมของรอบเทรดหนึ่งสำหรับคู่ ZECUSDT/DCRUSDT ที่ใช้พารามิเตอร์เดียวกันใน `config.yaml`.

## ภาพรวมชุดพารามิเตอร์หลัก
- สัญลักษณ์: ZECUSDT, DCRUSDT (`interval` 1m, `lookback_days` 2)
- ค่าธรรมเนียม: taker/maker 0.1% (`fees: { taker: 0.001, maker: 0.001 }`)
- บันไดซื้อหลัก: `d_buy` 1.5%, `m_buy` 1.5, `n_steps` 10, `spacing_mode` fibo, จำกัดความลึกด้วย `max_step_drop` 25%【F:config.yaml†L7-L48】
- ใช้ maker เป็นหลัก (`use_maker: true`) และขายแบบแบ่ง 2 ชิ้น (`sell_scale_out: { chunks: 2, delay_seconds: 1, profit_only: true }`)【F:config.yaml†L147-L151】

## ตรวจสอบว่าเข้าเงื่อนไขแนวคิด Fibonacci + micro แยกจาก ladder หรือไม่
- **ระยะ–ขนาดตามลำดับ Fibonacci**: บันไดหลักตั้งทั้ง `spacing_mode: fibo` และ `size_mode: fibonacci` ดังนั้นไม้ 1–10 จะไล่สัดส่วน 1, 1, 2, 3, 5, 8, 13 … ทั้งในระยะห่าง (%) และขนาดทุนต่อไม้ โดยใช้ `gap_factor` 1.05 และเพดาน `max_step_drop` 25% ตัดความลึกที่มากเกินไป【F:config.yaml†L19-L28】
- **จำกัดทุนรวม 10 ไม้ไม่เกิน `b_alloc`**: ทุกคู่มี `b_alloc` ระบุชัด (เช่น ZECUSDT 23,456 USDT) ขณะที่ `n_steps` 10 กับโหมด Fibonacci ทำให้ไม้แรกเล็กและเพิ่มขึ้นตามสัดส่วน แต่ยังถูกจำกัดเพดานทุนที่ตั้งไว้ในคู่【F:config.yaml†L7-L28】
- **คำสั่งย่อย/ไมโครแยกจากบันได**: `scalp_mode` และ `micro_oscillation` เปิดใช้งานด้วยสัดส่วนทุน 33%/15% ของรอบ เพื่อเข้าระยะสั้นแบบ micro โดยไม่รวมกับ ladder หลัก ส่วน `buy_the_dip` กำหนด `isolate_from_ladder: true` ทำให้คำสั่งดักหลุดฐานไม่ถูกนับรวมขั้นบันได แต่จะรีเบสจุดอ้างอิงใหม่แทน【F:config.yaml†L54-L95】
- **สะสมกำไรก่อนปล่อย sell-the-rip**: เมื่อมีการสะสมจนกำไรเพียงพอ ระบบขายบนยอดใช้ `sell_at_height` (pullback 0.4–2%) เพื่อ “sell the rip” และถูกแยกจาก profit trail ปกติ ช่วยปลดล็อกกำไรที่สะสมไว้โดยไม่ต้องรอเงื่อนไข trail【F:config.yaml†L95-L106】
- **มีหน้าสรุป HTML**: หน้า `static/backtest/index.html` สำหรับรัน backtest จะแสดง PnL ต่อสัญลักษณ์/ช่วงเวลา เมื่อรวมผลรอบที่มี scalp/micro/dip ก็จะถูกสะท้อนในผลรวม แต่ logic ซื้อขายแต่ละโหมดแยกชั้นไว้ตาม config【F:static/backtest/index.html†L1-L126】

## วัฏจักรซื้อ–สะสม (10 ไม้ fibo + dip + scalp)
1. **เริ่มรอบด้วยบันได fibo**: ไม้ 1 ห่างจากราคาอ้างอิง ~1.5% แล้วเว้นช่วงลึกขึ้นตาม Fibonacci (1.5%, 2.4%, 3.9%, 6.3% …) จนถึงไม้ 10 แต่ถูกครอบด้วย `max_step_drop` 25% ทำให้บันไดหยุดลึกสุด ~ -25%【F:config.yaml†L13-L32】
2. **ตัวอย่างเส้นทาง 10 ไม้** (ราคาเริ่ม 370 สมมติ quote เริ่มต้น 60 และคูณ m_buy = 1.5 ต่อขั้น):
   - ไม้ 1: 364.5 (-1.5%), 60 USDT
   - ไม้ 2: 355.8 (-3.9% สะสม fibo), 90 USDT
   - ไม้ 3: 341.8 (-7.2%), 135 USDT
   - ไม้ 4: 323.3 (-12.6%), 203 USDT
   - ไม้ 5: 299.2 (-19.2%), 304 USDT
   - ไม้ 6: 272.3 (-26.4%) **จะถูกตัดให้ไม่ต่ำกว่า -25% ตาม max_step_drop**
   - ไม้ 7–10: ไม่ถูกยิงต่อเพราะชนเพดาน -25% ทำให้ทุนไม่บานปลายเกินช่วงที่กำหนด
3. **Adaptive Ladder**: หลังยิงครบ `bootstrap_steps` 3 ไม้ บอทจะคำนวณ `d_buy` ใหม่ในช่วง 2–8% ตามความผันผวน 120 แท่ง, `sensitivity` 0.6 ถ้าราคาแกว่งสูงจะขยายระยะห่าง ลดการไล่ลงลึกเกินไป【F:config.yaml†L92-L107】
4. **Anchor Drift**: ติดตามโครงสร้างราคาย่อย (ATR 14, breakout multiplier 1.2) ถ้าราคาเบรกหรือหลุดโครงสร้างจะเลื่อน anchor ใหม่ เพื่อลด false fill ระหว่างช่วง sideway【F:config.yaml†L108-L122】
5. **Buy The Dip (แยกจากบันไดหลัก)**: หากราคาหลุด anchor ลง ≥5% จะตั้งคำสั่ง dip โดยใช้ 50% ของทุนคงเหลือ (`order_pct_remaining: 0.5`) รีเบส ladder จากจุด dip และแยกจากบันไดหลัก (`isolate_from_ladder: true`) จึงลดการยิงไม้ลึกหลายชั้นซ้ำซ้อน【F:config.yaml†L59-L81】
6. **Scalp Mode 10 ไม้**: ระหว่างทางถ้าราคาดรอป 2–6% (base_drop_pct 3% ปรับด้วย volatility) จะเปิดออเดอร์ย่อยขนาด ~33% ของทุนรอบนั้น (`order_pct_allocation: 0.33`) ตั้ง TP สั้น 0.8–2% และมี `max_trades` 10 ทำให้เก็บกำไรสั้นได้แม้บันไดหลักยังไม่เริ่ม【F:config.yaml†L34-L58】

### รูปแบบที่เป็นไปได้ (ซื้อ)
- **ลึกสไตล์ fibo + cap 25%**: เติมไม้ 1–5 จน ~-19% ถ้าราคายังไหลต่อเล็กน้อยจะถูก cap ที่ -25% ทำให้ไม้ที่ 6 เป็นสุดท้ายในรอบสะสมหลัก
- **ผสาน dip**: ถ้าราคาทุบแรงเกินบันไดหลัก (-5% จาก anchor) จะมีคำสั่ง dip แทรกก่อนถึงไม้ลึกของบันได แล้วรีเบสให้ไม้ถัดไปขยับขึ้น ลดการลากทุนลึก
- **Scalp ระหว่างทาง**: หากมีสวิงสั้น 2–6% จะยิง scalp ไม้เล็กและปิดเร็ว 0.8–2% ทำให้รอบหนึ่งอาจเกิด 5–10 ไม้ scalp ซ้อนกับ 3–6 ไม้บันได

## วัฏจักรขาย (trail + sell_at_height + scale-out)
1. **Profit Trail**: เมื่อราคาเด้งจาก Avg ถึง `p_min` 2% จะเริ่มลากเส้น trail ด้วย `s1` 1%, multiplier 1.6 และ `tau` 0.7 เพื่อขยับจุดล็อกกำไรตามความชัน ถ้ามีเวลานานจะลดความกว้างของ trail ด้วย `tau_min` 0.3 และ `p_lock_base/max` 0.5–2%【F:config.yaml†L18-L31】
2. **Sell Scale-Out**: เมื่อเงื่อนไขขายสำเร็จ จะขายแบ่ง 2 ชิ้น ห่างกัน 1 วินาที เพื่อลด slippage โดยขายเฉพาะช่วงที่มีกำไร (`profit_only: true`)【F:config.yaml†L147-L151】
3. **Sell at Height (Rip Play)**: ถ้าราคายืดสูงกว่า anchor 4% แล้วดึงกลับ 0.4–2% จะส่งขาย 50% ของตำแหน่งทันที (`order_pct_position: 0.5`) ใช้ limit offset 0.1% ถ้าพลาดจะถูกยกเลิก (`cancel_on_miss: true`)【F:config.yaml†L82-L91】
4. **เวลาเป็นตัวเร่ง (Time Caps)**: ถ้า idle 45 นาทีโดยไม่โดน TP จะปิดที่กำไรขั้นต่ำ 0.4% (`p_idle`) หรือปิดทั้งรอบที่ 180 นาที (`T_total_cap_minutes`) เพื่อหลีกเลี่ยงการกอดของนาน【F:config.yaml†L40-L55】

### รูปแบบที่เป็นไปได้ (ขาย)
- **ล็อกกำไรแบบไต่ชั้น**: หลังเฉลี่ยต้นทุนแล้วดีดกลับ >2% จะเริ่ม trail และ scale-out 2 ไม้ ถ้าราคายังคงไปต่อ เส้น trail จะยกสูงขึ้นเรื่อยๆ ตาม `m_step`
- **ขายบนยอดชั่วคราว**: ในสภาพ squeeze ขึ้นแรง >4% แล้วดึงกลับ 0.8–1% จะยิง sell_at_height 50% ทันที แม้ profit trail ยังไม่ทำงานเต็มที่
- **บังคับจบด้วยเวลา**: ถ้าตลาดนิ่งและไม่ถึงเงื่อนไขอื่น จะปิดรอบด้วยกำไรบางส่วนตาม p_idle หรือปิดทั้งพอร์ตเมื่อครบ 180 นาที

## ตัวอย่างเส้นทางสมมติ (รวมซื้อ–ขายหลายแนว)
1. ราคาเริ่ม 370 → ไหลลง -7% ใน 15 นาที → ยิงไม้ 1–3 (364.5, 355.8, 341.8) + scalp 2 ไม้ย่อยที่ -3%/-5% แล้วปิด scalp ที่ +1%
2. ราคาไหลต่อ -12% → ยิงไม้ 4 ที่ 323.3, buy_the_dip ทำงานที่ -5% จาก anchor ใหม่ เพิ่มออเดอร์แยก 50% ทุนคงเหลือ
3. ราคารีบาวด์ 6% จากจุดต่ำ → Avg ลดเหลือ ~335–340 → profit trail เริ่มที่ +2% จาก Avg → ขาย chunk 1 ที่ +2.5%, chunk 2 ที่ +3.0%
4. หากระหว่างรีบาวด์เกิด spike +4% แล้วดึงกลับ 1% → sell_at_height จะตัด 50% ทันที จากนั้น profit trail จัดการส่วนที่เหลือ

ผลรวม: รอบเดียวอาจเกิด 5–6 ไม้บันไดหลัก + 1–3 คำสั่ง dip + 3–8 ไม้ scalp และขาย 2–4 ไม้ (trail + rip) ทั้งหมดเป็นไปตามข้อจำกัดความลึก 25% และเพดานเวลารอบ 180 นาทีใน config ปัจจุบัน

> หมายเหตุ: ตัวเลขราคาและจำนวนเป็นการยกตัวอย่างเพื่ออธิบายลำดับการทำงานตามพารามิเตอร์ใน `config.yaml` จริง การเติม/ปิดออเดอร์ขึ้นอยู่กับตลาดสดจริง, slippage, สภาพคล่อง และค่าธรรมเนียม ณ ขณะนั้น