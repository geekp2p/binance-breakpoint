# สรุปง่ายๆ ว่า `live_trader.py` ทำอะไร

บอทนี้คือสคริปต์เทรดสดบน Binance Spot ที่อ่านการตั้งค่าจาก `config.yaml` แล้วทำงานวนรอบตามแท่งราคา (เช่น 1 นาที) เพื่อทยอยซื้อเป็นขั้นๆ และขายเมื่อเข้าเงื่อนไขกำไร/เวลา โดยบันทึกสถานะลงไฟล์เซฟพอยต์เสมอ

## โฟลว์การทำงานย่อๆ
1. โหลดคอนฟิกและคีย์ Binance (ไม่ใส่คีย์ = โหมดจำลอง `--dry-run`).
2. เลือกคู่เหรียญตามที่ระบุ (ถ้าไม่ระบุจะรันทุกคู่ใน `pairs`).
3. สร้างสถานะเริ่มต้นจากแท่งที่ปิดล่าสุดหรือโหลดจากเซฟพอยต์เก่า.
4. ทุกแท่งราคาที่ปิด:
   - ส่งข้อมูลเข้าเครื่องยนต์กลยุทธ์ให้คำนวณสัญญาณ.
   - ถ้าเจอคำสั่ง BUY จะตรวจงบคงเหลือ ปรับขนาดคำสั่งให้พอดี แล้วส่ง `market buy`.
   - ถ้าได้สัญญาณออกจะขายแบบก้อนเดียวหรือแบ่งก้อนตามตั้งค่า แล้วรีเซ็ตรอบใหม่.
   - บันทึกเหตุการณ์/สถานะลงไฟล์ JSONL/CSV และเซฟพอยต์เพื่อกู้กลับได้.

## เงื่อนไขหลักๆ และจำนวน "ไม้" ซื้อ
- `buy_ladder`: กำหนดบันไดซื้อหลัก
  - `d_buy`: ห่างจากราคาเริ่มรอบเท่าไรถึงจะวางไม้แรก.
  - `n_steps`: จำนวนไม้สูงสุดในรอบ (เช่น 10 ไม้).
  - `spacing_mode`: จะเว้นช่วงแบบ Fibonacci (`fibo`) หรือเว้นคงที่ (`geometric`).
  - `m_buy`: ไม้ถัดไปจะคูณขนาดเพิ่มตามค่านี้.
- ฟีเจอร์เสริมที่เพิ่มจำนวนไม้ได้
  - `buy_the_dip`: เปิดไม้ดักหลุดบันไดหลักได้อีกหลายไม้ตาม `max_orders` (แยกจาก `n_steps`).
  - `scalp_mode`: เข้าออกเร็วคนละชุดกับบันไดหลัก มี `max_trades` ต่อรอบ.
- เพดานเงินต่อรอบ
  - `b_alloc`: งบ quote สูงสุดที่ใช้ได้ต่อรอบหลัก (ไม่รวมไม้ดัก dip ถ้าตั้ง `order_pct_remaining`).

## เงื่อนไขขาย/ปิดรอบ
- `profit_trail`: ลากกำไรเมื่อขึ้นถึง `p_min` แล้วขยับจุดล็อกกำไรตาม `s1`, `m_step`, `tau` จนถึง `p_lock_max`.
- `time_caps`: ถ้าราคานิ่งหรือใช้เวลานานเกิน `T_idle_max_minutes` หรือ `T_total_cap_minutes` จะปิดรอบด้วยกำไรขั้นต่ำ (`p_idle` / `p_exit_min`).
- `sell_scale_out`: ตั้งให้แบ่งขายหลายก้อน พร้อมดีเลย์ระหว่างก้อน และเลือกขายเฉพาะเมื่อกำไรได้.

## สิ่งที่บันทึกไว้ให้กู้กลับ
- สถานะรอบ, บันไดราคาปัจจุบัน, ปริมาณสะสม, จุดคุ้มทุน, กำไรที่รับรู้แล้ว, ประวัติเหตุการณ์/กิจกรรม.
- ไฟล์อยู่ใต้ `savepoint_dir/<SYMBOL>/` ทั้งแบบ `.jsonl` และ `.csv` กู้ขึ้นมาเมื่อรีสตาร์ตโปรแกรมได้.

## เชื่อมต่อ Binance อย่างไร
- ใช้ `BINANCE_API_KEY` และ `BINANCE_API_SECRET` (หรือกำหนดใน `config.yaml`).
- ตรวจยอดคงเหลือก่อนส่งคำสั่งทุกครั้ง; หากงบไม่พอจะลดขนาดคำสั่งให้อัตโนมัติ.
- ส่งคำสั่งแบบ market (ซื้อด้วยจำนวน quote, ขายด้วยจำนวนเหรียญ) และหักค่าคอมมิชชันตามยอดที่ส่งกลับมาจริง.